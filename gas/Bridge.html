<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bridge</title>
  </head>
  <body>
    <script>
      (function () {
        'use strict';

        const ALLOWED_METHODS = {
          getParticipantOptions: true,
          participantLogin: true,
          saveParticipantPredictions: true,
          getVisiblePredictions: true,
          getParticipantScoreboard: true,
          getParticipantCrowdForecast: true,
          adminGetDashboard: true,
          adminUpdateConfig: true,
          adminAddParticipant: true,
          adminDeleteParticipant: true,
          adminSaveResults: true,
        };

        function reply(targetOrigin, payload) {
          // GAS web app may be wrapped by script.google.com -> script.googleusercontent.com nested frames.
          // Post to top so the GitHub Pages parent can receive messages reliably.
          var targetWin = window.top || window.parent;
          try {
            targetWin.postMessage(payload, targetOrigin || '*');
          } catch (err) {
            targetWin.postMessage(payload, '*');
          }
        }

        window.addEventListener('message', function (event) {
          const msg = event.data || {};
          if (!msg || msg.type !== 'gas-rpc-request') return;

          const id = msg.id;
          const method = String(msg.method || '');
          const args = Array.isArray(msg.args) ? msg.args : [];

          if (!ALLOWED_METHODS[method]) {
            reply('*', {
              type: 'gas-rpc-response',
              id: id,
              ok: false,
              error: '許可されていないAPIです: ' + method,
            });
            return;
          }

          try {
            google.script.run
              .withSuccessHandler(function (result) {
                reply('*', { type: 'gas-rpc-response', id: id, ok: true, result: result });
              })
              .withFailureHandler(function (err) {
                reply('*', {
                  type: 'gas-rpc-response',
                  id: id,
                  ok: false,
                  error: (err && err.message) || String(err || 'Unknown error'),
                });
              })[method].apply(null, args);
          } catch (err) {
            reply('*', {
              type: 'gas-rpc-response',
              id: id,
              ok: false,
              error: (err && err.message) || String(err || 'Unknown error'),
            });
          }
        });

        // Debug ping: confirms Bridge JS is actually executing in iframe context.
        try {
          google.script.run
            .withFailureHandler(function () {})
            .bridgePing({
              href: String(location.href || ''),
              hasTop: !!window.top,
              hasParent: !!window.parent,
            });
        } catch (err) {}

        // Wrappers may initialize asynchronously; send ready more than once.
        reply('*', { type: 'gas-bridge-ready' });
        setTimeout(function () { reply('*', { type: 'gas-bridge-ready' }); }, 300);
        setTimeout(function () { reply('*', { type: 'gas-bridge-ready' }); }, 1000);
      })();
    </script>
  </body>
  </html>
